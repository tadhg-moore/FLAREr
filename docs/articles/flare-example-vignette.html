<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FLAREr example • FLAREr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="FLAREr example">
<meta property="og:description" content="FLAREr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">FLAREr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/flare-config-vignette.html">FLAREr configurations</a>
    </li>
    <li>
      <a href="../articles/flare-example-vignette.html">FLAREr example</a>
    </li>
    <li>
      <a href="../articles/flare-workflow-vignette.html">Example Workflow</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="flare-example-vignette_files/header-attrs-2.8/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>FLAREr example</h1>
            
      
      
      <div class="hidden name"><code>flare-example-vignette.Rmd</code></div>

    </div>

    
    
<div id="background" class="section level2">
<h2 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h2>
<p>This document serves as a users guide and a tutorial for the FLARE (Forecasting Lake and Reservoir Ecosystems) system (<a href="https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1029/2019WR026138">Thomas et al. 2020</a>). FLARE generates forecasts and forecast uncertainty of water temperature and water quality for a 16-day time horizon at multiple depths of a lake or reservoir. It uses data assimilation to update the initial starting point for a forecast and the model parameters based a real-time statistical comparsions to observations. It has been developed, tested, and evaluated for Falling Creek Reservoir in Vinton,VA (<a href="https://agupubs.onlinelibrary.wiley.com/doi/abs/10.1029/2019WR026138">Thomas et al. 2020</a>).</p>
<p>FLARE is a set of R scripts that</p>
<ul>
<li>Generating the inputs and configuration files required by the General Lake Model (GLM)</li>
<li>Applying data assimilation to GLM</li>
<li>Processing and archiving forecast output</li>
<li>Visualizing forecast output</li>
</ul>
<p>FLARE uses the 1-D General Lake Model (<a href="https://www.geosci-model-dev.net/12/473/2019/">Hipsey et al. 2019</a>) as the mechanistic process model that predicts hydrodynamics of the lake or reservoir. For forecasts of water quality, it uses GLM with the Aquatic Ecosystem Dynamics library. The binaries for GLM and GLM-AED are included in the FLARE code that is available on GitHub. FLARE requires GLM version 3.1 or higher.</p>
<p>More information about the GLM can be found here:</p>
<ul>
<li><a href="https://aed.see.uwa.edu.au/research/models/GLM/index.html">GLM users guide</a></li>
<li><a href="https://www.geosci-model-dev.net/12/473/2019/">GLM 3.0.0 manuscript</a></li>
<li><a href="https://github.com/AquaticEcoDynamics/GLM">GLM on GitHub</a></li>
<li><a href="https://github.com/AquaticEcoDynamics/libaed2">AED on GitHub</a></li>
</ul>
<p>FLARE development has been supported by grants from National Science Foundation (CNS-1737424, DEB-1753639, EF-1702506, DBI-1933016, DEB-1926050)</p>
</div>
<div id="requirements" class="section level2">
<h2 class="hasAnchor">
<a href="#requirements" class="anchor"></a>Requirements</h2>
<ul>
<li><a href="https://rstudio.com/products/rstudio/download/">RStudio</a></li>
<li>
<code>FLAREr</code> R package</li>
<li>
<code>FLAREr</code> dependencies</li>
</ul>
</div>
<div id="set-up" class="section level2">
<h2 class="hasAnchor">
<a href="#set-up" class="anchor"></a>1: Set up</h2>
<p>First, install the <code>FLAREr</code> package from GitHub. There will be other required packages that will also be downloaded.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"flare-forecast/FLAREr"</span><span class="op">)</span></code></pre></div>
<p>Second, create a directory that will be your working directory for your FLARE run</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">forecast_location</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#forecast_location &lt;- "/Users/quinn/Dropbox/Research/SSC_forecasting/flare_users_guide_v2/forecast_location"</span></code></pre></div>
</div>
<div id="configuration-files" class="section level2">
<h2 class="hasAnchor">
<a href="#configuration-files" class="anchor"></a>2: Configuration files</h2>
<p>First, <code>FLAREr</code> requires two configuration yaml files. The code below copies examples from the <code>FLAREr</code> package.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"configure_flare.yml"</span>, package<span class="op">=</span><span class="st">"FLAREr"</span><span class="op">)</span>, <span class="va">forecast_location</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span>
<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"run_configuration.yml"</span>, package<span class="op">=</span><span class="st">"FLAREr"</span><span class="op">)</span>, <span class="va">forecast_location</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
<p>Second, <code>FLAREr</code> requires a set of configuration CSV files. The CSV files are used to define the states that are simulated and the parameters that are calibrated. The code below copies examples from the <code>FLAREr</code> package</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"parameter_calibration_config.csv"</span>, package<span class="op">=</span><span class="st">"FLAREr"</span><span class="op">)</span>, <span class="va">forecast_location</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span>
<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"states_config.csv"</span>, package<span class="op">=</span><span class="st">"FLAREr"</span><span class="op">)</span>, <span class="va">forecast_location</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span>
<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"states_process_error.csv"</span>, package<span class="op">=</span><span class="st">"FLAREr"</span><span class="op">)</span>, <span class="va">forecast_location</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span>
<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"observations_config.csv"</span>, package<span class="op">=</span><span class="st">"FLAREr"</span><span class="op">)</span>, <span class="va">forecast_location</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
<p>Third, FLAREr requires GLM specific configurations files. For applications that require on water temperature, only the GLM namelist file is needed. Applications that require other water quality variables will require additional namelist files that are associated with the AED model.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"glm3.nml"</span>, package<span class="op">=</span><span class="st">"FLAREr"</span><span class="op">)</span>, <span class="va">forecast_location</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
</div>
<div id="observation-and-driver-files" class="section level2">
<h2 class="hasAnchor">
<a href="#observation-and-driver-files" class="anchor"></a>3: Observation and driver files</h2>
<p>Since the FLAREr package for general application, scripts to download and process observation and drivers are not included in the package. Therefore the application of FLARE to a lake will require a set of additional scripts that are specific to the data formats for the lakes. The example includes files for application to FCR.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.copy</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"data/input_data"</span>, package<span class="op">=</span> <span class="st">"FLAREr"</span><span class="op">)</span>, to <span class="op">=</span> <span class="va">forecast_location</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
<p>First, FLAREr requires the observation file to have a specific name (observations_postQAQC_long.csv) and format.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu">read_csv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">forecast_location</span>,<span class="st">"/input_data/observations_postQAQC_long.csv"</span><span class="op">)</span>, col_types <span class="op">=</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 5</span>
<span class="co">#&gt;   date        hour depth value variable   </span>
<span class="co">#&gt;   &lt;date&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;      </span>
<span class="co">#&gt; 1 2018-07-06     0     0  28.4 temperature</span>
<span class="co">#&gt; 2 2018-07-06     0     1  28.4 temperature</span>
<span class="co">#&gt; 3 2018-07-06     0     2  24.2 temperature</span>
<span class="co">#&gt; 4 2018-07-06     0     3  18.2 temperature</span>
<span class="co">#&gt; 5 2018-07-06     0     4  13.5 temperature</span>
<span class="co">#&gt; 6 2018-07-06     0     5  11.2 temperature</span></code></pre></div>
<p>Second, FLARE are requires the observed (historical) meteorology to be a specific name (observed-met_fcre.nc) and format.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ncdf4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/nc_open.html">nc_open</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">forecast_location</span>, <span class="st">"input_data/observed-met_fcre.nc"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; File /var/folders/ms/kf9vk0w17p18pvs8k_23t5y80000gq/T//Rtmp1br3RJ/input_data/observed-met_fcre.nc (NC_FORMAT_CLASSIC):</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;      8 variables (excluding dimension variables):</span>
<span class="co">#&gt;         float air_temperature[time,latitude,longitude]   </span>
<span class="co">#&gt;             units: K</span>
<span class="co">#&gt;             _FillValue: NaN</span>
<span class="co">#&gt;         float air_pressure[time,latitude,longitude]   </span>
<span class="co">#&gt;             units: Pa</span>
<span class="co">#&gt;             _FillValue: NaN</span>
<span class="co">#&gt;         float relative_humidity[time,latitude,longitude]   </span>
<span class="co">#&gt;             units: 1</span>
<span class="co">#&gt;             _FillValue: NaN</span>
<span class="co">#&gt;         float surface_downwelling_longwave_flux_in_air[time,latitude,longitude]   </span>
<span class="co">#&gt;             units: Wm-2</span>
<span class="co">#&gt;             _FillValue: NaN</span>
<span class="co">#&gt;         float surface_downwelling_shortwave_flux_in_air[time,latitude,longitude]   </span>
<span class="co">#&gt;             units: Wm-2</span>
<span class="co">#&gt;             _FillValue: NaN</span>
<span class="co">#&gt;         float precipitation_flux[time,latitude,longitude]   </span>
<span class="co">#&gt;             units: kgm-2s-1</span>
<span class="co">#&gt;             _FillValue: NaN</span>
<span class="co">#&gt;         float specific_humidity[time,latitude,longitude]   </span>
<span class="co">#&gt;             units: 1</span>
<span class="co">#&gt;             _FillValue: NaN</span>
<span class="co">#&gt;         float wind_speed[time,latitude,longitude]   </span>
<span class="co">#&gt;             units: ms-1</span>
<span class="co">#&gt;             _FillValue: NaN</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;      3 dimensions:</span>
<span class="co">#&gt;         time  Size:45192</span>
<span class="co">#&gt;             units: hours since 2015-07-07 20:00</span>
<span class="co">#&gt;             long_name: time</span>
<span class="co">#&gt;         latitude  Size:1</span>
<span class="co">#&gt;             units: degree_north</span>
<span class="co">#&gt;             long_name: latitude</span>
<span class="co">#&gt;         longitude  Size:1</span>
<span class="co">#&gt;             units: degree_east</span>
<span class="co">#&gt;             long_name: longitude</span></code></pre></div>
<p>Third, FLARE are requires the observed (historical) inflow and outflow to be a specific name (inflow_postQAQC.csv) and format.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu">read_csv</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">forecast_location</span>, <span class="st">"/input_data/inflow_postQAQC.csv"</span><span class="op">)</span>, col_types <span class="op">=</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 4</span>
<span class="co">#&gt;   time         FLOW  TEMP  SALT</span>
<span class="co">#&gt;   &lt;date&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt; 1 2013-05-15 0.0160  15.7     0</span>
<span class="co">#&gt; 2 2013-05-16 0.0150  15.3     0</span>
<span class="co">#&gt; 3 2013-05-17 0.0141  15.3     0</span>
<span class="co">#&gt; 4 2013-05-18 0.0170  14.9     0</span>
<span class="co">#&gt; 5 2013-05-19 0.0241  14.6     0</span>
<span class="co">#&gt; 6 2013-05-20 0.0385  14.4     0</span></code></pre></div>
<p>Finally, if using forecasted meteorology and inflows, FLAREr requires specific file formats and file names with specific characters (INFLOW or OUTFLOW). The follow set of files are the forecasted inflow files in the example.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">forecast_location</span>,<span class="st">"input_data/FLOWS-NOAAGEFS-AR1"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">all_files</span><span class="op">[</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">all_files</span>,<span class="st">"INFLOW"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt;  [1] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens01.csv"</span>
<span class="co">#&gt;  [2] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens02.csv"</span>
<span class="co">#&gt;  [3] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens03.csv"</span>
<span class="co">#&gt;  [4] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens04.csv"</span>
<span class="co">#&gt;  [5] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens05.csv"</span>
<span class="co">#&gt;  [6] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens06.csv"</span>
<span class="co">#&gt;  [7] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens07.csv"</span>
<span class="co">#&gt;  [8] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens08.csv"</span>
<span class="co">#&gt;  [9] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens09.csv"</span>
<span class="co">#&gt; [10] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens10.csv"</span>
<span class="co">#&gt; [11] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens11.csv"</span>
<span class="co">#&gt; [12] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens12.csv"</span>
<span class="co">#&gt; [13] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens13.csv"</span>
<span class="co">#&gt; [14] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens14.csv"</span>
<span class="co">#&gt; [15] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens15.csv"</span>
<span class="co">#&gt; [16] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens16.csv"</span>
<span class="co">#&gt; [17] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens17.csv"</span>
<span class="co">#&gt; [18] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens18.csv"</span>
<span class="co">#&gt; [19] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens19.csv"</span>
<span class="co">#&gt; [20] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens20.csv"</span>
<span class="co">#&gt; [21] "INFLOW-FLOWS-NOAAGEFS-AR1_fcre_2018-10-05_2018-10-20_ens21.csv"</span></code></pre></div>
<p>with the following format</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fu">read_csv</span><span class="op">(</span><span class="va">all_files</span><span class="op">[</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">all_files</span>,<span class="st">"INFLOW"</span><span class="op">)</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, col_types <span class="op">=</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 8</span>
<span class="co">#&gt;   time         FLOW  TEMP  SALT AirTemp     Rain type   inflow_num</span>
<span class="co">#&gt;   &lt;date&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;</span>
<span class="co">#&gt; 1 2018-10-05 0.006   19.2     0    20.1 0.00343  inflow          1</span>
<span class="co">#&gt; 2 2018-10-06 0.008   19.1     0    21.6 0.000583 inflow          1</span>
<span class="co">#&gt; 3 2018-10-07 0.0088  19.2     0    19.5 0.00179  inflow          1</span>
<span class="co">#&gt; 4 2018-10-08 0.0101  19.1     0    19.5 0.00322  inflow          1</span>
<span class="co">#&gt; 5 2018-10-09 0.0118  19.0     0    19.7 0.00279  inflow          1</span>
<span class="co">#&gt; 6 2018-10-10 0.0132  19.0     0    20.6 0.00117  inflow          1</span></code></pre></div>
<p>Similarly, the forecasted NOAA GEFS meteorology has a specific file formats and file names with specific characters (NOAAGEGS_1hr). The follow set of files are the forecasted meteorology files in the example.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">forecast_location</span>, <span class="st">"input_data/NOAAGEFS_1hr-debias"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">all_files</span><span class="op">)</span>
<span class="co">#&gt;  [1] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens01.nc"</span>
<span class="co">#&gt;  [2] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens02.nc"</span>
<span class="co">#&gt;  [3] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens03.nc"</span>
<span class="co">#&gt;  [4] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens04.nc"</span>
<span class="co">#&gt;  [5] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens05.nc"</span>
<span class="co">#&gt;  [6] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens06.nc"</span>
<span class="co">#&gt;  [7] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens07.nc"</span>
<span class="co">#&gt;  [8] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens08.nc"</span>
<span class="co">#&gt;  [9] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens09.nc"</span>
<span class="co">#&gt; [10] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens10.nc"</span>
<span class="co">#&gt; [11] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens11.nc"</span>
<span class="co">#&gt; [12] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens12.nc"</span>
<span class="co">#&gt; [13] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens13.nc"</span>
<span class="co">#&gt; [14] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens14.nc"</span>
<span class="co">#&gt; [15] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens15.nc"</span>
<span class="co">#&gt; [16] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens16.nc"</span>
<span class="co">#&gt; [17] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens17.nc"</span>
<span class="co">#&gt; [18] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens18.nc"</span>
<span class="co">#&gt; [19] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens19.nc"</span>
<span class="co">#&gt; [20] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens20.nc"</span>
<span class="co">#&gt; [21] "NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens21.nc"</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ncdf4</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/nc_open.html">nc_open</a></span><span class="op">(</span><span class="va">all_files</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt; File /var/folders/ms/kf9vk0w17p18pvs8k_23t5y80000gq/T//Rtmp1br3RJ/input_data/NOAAGEFS_1hr-debias/NOAAGEFS_1hr-debias_fcre_2018-10-05T00_2018-10-21T00_ens01.nc (NC_FORMAT_CLASSIC):</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;      6 variables (excluding dimension variables):</span>
<span class="co">#&gt;         float air_temperature[time,latitude,longitude]   </span>
<span class="co">#&gt;             units: K</span>
<span class="co">#&gt;             _FillValue: NaN</span>
<span class="co">#&gt;         float relative_humidity[time,latitude,longitude]   </span>
<span class="co">#&gt;             units: 1</span>
<span class="co">#&gt;             _FillValue: NaN</span>
<span class="co">#&gt;         float surface_downwelling_longwave_flux_in_air[time,latitude,longitude]   </span>
<span class="co">#&gt;             units: Wm-2</span>
<span class="co">#&gt;             _FillValue: NaN</span>
<span class="co">#&gt;         float surface_downwelling_shortwave_flux_in_air[time,latitude,longitude]   </span>
<span class="co">#&gt;             units: Wm-2</span>
<span class="co">#&gt;             _FillValue: NaN</span>
<span class="co">#&gt;         float precipitation_flux[time,latitude,longitude]   </span>
<span class="co">#&gt;             units: kgm-2s-1</span>
<span class="co">#&gt;             _FillValue: NaN</span>
<span class="co">#&gt;         float wind_speed[time,latitude,longitude]   </span>
<span class="co">#&gt;             units: ms-1</span>
<span class="co">#&gt;             _FillValue: NaN</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;      3 dimensions:</span>
<span class="co">#&gt;         time  Size:385</span>
<span class="co">#&gt;             units: hours since 2018-10-05 00:00</span>
<span class="co">#&gt;             long_name: time</span>
<span class="co">#&gt;         latitude  Size:1</span>
<span class="co">#&gt;             units: degree_north</span>
<span class="co">#&gt;             long_name: latitude</span>
<span class="co">#&gt;         longitude  Size:1</span>
<span class="co">#&gt;             units: degree_east</span>
<span class="co">#&gt;             long_name: longitude</span></code></pre></div>
</div>
<div id="configure-simulation-glm" class="section level2">
<h2 class="hasAnchor">
<a href="#configure-simulation-glm" class="anchor"></a>2: Configure simulation (GLM)</h2>
<p>The configuration functions are spread across the files. These files are described in more detail below</p>
<ul>
<li><code>glm3.nml</code></li>
<li><code>configure_flare.yml</code></li>
<li><code>run_configuration.yml</code></li>
<li><code>states_config.csv</code></li>
<li><code>observations_config.csv</code></li>
<li><code>parameter_calibration_config.csv</code></li>
<li><code>states_process_error.csv</code></li>
</ul>
<div id="run_configuration-yml" class="section level3">
<h3 class="hasAnchor">
<a href="#run_configuration-yml" class="anchor"></a>run_configuration.yml</h3>
<p>This file is the configuration file that define the specific timing of the run.</p>
<ul>
<li>
<code>forecast_location</code>: This is the <code>flare_simulation</code> directory (full path; you will need to change this to reflect the location of your directory)</li>
<li>
<code>execute_location</code>: This is the same as <code>forecast_location</code> unless you are executing the simulation in a different directory. I use this to execute the code on a RAM disk to save read-writes to my hard disk. You don’t need to do this in the tutorial</li>
<li>
<code>restart_file</code>: This is the full path to the file that you want to use as initial conditions for the simulation. You will set this to <code>NA</code> if the simulation is not a continuation of a previous simulation.</li>
<li>
<code>sim_name</code>: a string with the name of your simulation. This will appear in your output file names</li>
<li>
<code>forecast_days</code>: This is your forecast horizon. The max is <code>16</code> days. Set to <code>0</code>if only doing data assimilation with observed drivers.</li>
<li>
<code>start_datetime</code>: The date time of day you want to start a forecast. Because GLM is a daily timestep model, the simulation will start at this time. It uses <code>YYYY-MM-DD mm:hh:ss</code> format and must only be a whole hour. It is in the UTC time. It can be any hour if only doing data assimilation with observed drivers (forecast_days = 0). If forecasting (forecast_days &gt; 0) it is required to match up with the availability of a NOAA forecast. NOAA forecasts are available at the following times UTC so you must select a local time that matches one of these times (i.e., 07:00:00 at FCR is the 12:00:00 UTC NOAA forecast).
<ul>
<li>00:00:00 UTC</li>
<li>06:00:00 UTC</li>
<li>12:00:00 UTC</li>
<li>18:00:00 UTC</li>
</ul>
</li>
<li>
<code>forecast_start_datetime</code>: The date that you want forecasting to start in your simulation. Uses the YYYY-MM-DD mm:hh:ss format (e.g., “2019-09-20 00:00:00”). The difference between <code>start_time</code> and <code>forecast_start_fyryimr</code> determines how many days of data assimilation occur using observed drivers before handing off to forecasted drivers and not assimilating data</li>
<li>
<code>forecast_sss_on</code>: Only used in AED simulations for setting the SSS (hypolimnetic oxygenation system) to on in the forecast</li>
</ul>
</div>
<div id="glm3-nml" class="section level3">
<h3 class="hasAnchor">
<a href="#glm3-nml" class="anchor"></a>glm3.nml</h3>
<p><code>glm3.nml</code> is the configuration file that is required by GLM. It can be configured to run only GLM or GLM + AED. This version is already configured to run only GLM for FCR and you do not need to modify it for the example simulation.</p>
</div>
<div id="configure_flare-yml" class="section level3">
<h3 class="hasAnchor">
<a href="#configure_flare-yml" class="anchor"></a>configure_flare.yml</h3>
<p><code>configure_flare.yml</code> has the bulk of the configurations for FLARE that you will set once and reuse. The end of this document describes all of the configurations in <code>configure_flare.yml</code>. Later in the tutorial, you will modify key configurations in <code>configure_flare.yml</code></p>
</div>
<div id="states_config-csv" class="section level3">
<h3 class="hasAnchor">
<a href="#states_config-csv" class="anchor"></a>states_config.csv</h3>
<p>Needs to be in your <code>forecast_location</code></p>
</div>
<div id="observations_config-csv" class="section level3">
<h3 class="hasAnchor">
<a href="#observations_config-csv" class="anchor"></a>observations_config.csv</h3>
<p>Needs to be in your <code>forecast_location</code></p>
</div>
<div id="observations_config-csv-1" class="section level3">
<h3 class="hasAnchor">
<a href="#observations_config-csv-1" class="anchor"></a>observations_config.csv</h3>
<p>Needs to be in your <code>forecast_location</code></p>
</div>
</div>
<div id="run-your-glm-example-simulation" class="section level2">
<h2 class="hasAnchor">
<a href="#run-your-glm-example-simulation" class="anchor"></a>3: Run your GLM example simulation</h2>
<p>Read configuration files</p>
<p>The following reads in the configuration files and overwrites the directory locations based on the forecast_location and working_directory provided above. In practice you will specific these directories in the configurate file and not overwrite them.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu">yaml</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/yaml/man/read_yaml.html">read_yaml</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">forecast_location</span>,<span class="st">"configure_flare.yml"</span><span class="op">)</span><span class="op">)</span>
<span class="va">run_config</span> <span class="op">&lt;-</span> <span class="fu">yaml</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/yaml/man/read_yaml.html">read_yaml</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">forecast_location</span>,<span class="st">"run_configuration.yml"</span><span class="op">)</span><span class="op">)</span>

<span class="va">config</span><span class="op">$</span><span class="va">run_config</span> <span class="op">&lt;-</span> <span class="va">run_config</span>
<span class="va">config</span><span class="op">$</span><span class="va">run_config</span><span class="op">$</span><span class="va">forecast_location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">forecast_location</span><span class="op">)</span>
<span class="va">config</span><span class="op">$</span><span class="va">run_config</span><span class="op">$</span><span class="va">execute_location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">forecast_location</span>, <span class="st">"working_directory"</span><span class="op">)</span>

<span class="va">config</span><span class="op">$</span><span class="va">data_location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">forecast_location</span>, <span class="st">"input_data"</span><span class="op">)</span>
<span class="va">config</span><span class="op">$</span><span class="va">qaqc_data_location</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">forecast_location</span>, <span class="st">"input_data"</span><span class="op">)</span>

<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.exists</a></span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">run_config</span><span class="op">$</span><span class="va">execute_location</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">run_config</span><span class="op">$</span><span class="va">execute_location</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Read in configuration CSV files</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pars_config</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">run_config</span><span class="op">$</span><span class="va">forecast_location</span>, <span class="va">config</span><span class="op">$</span><span class="va">par_file</span><span class="op">)</span>, col_types <span class="op">=</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">obs_config</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">run_config</span><span class="op">$</span><span class="va">forecast_location</span>, <span class="va">config</span><span class="op">$</span><span class="va">obs_config_file</span><span class="op">)</span>, col_types <span class="op">=</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">states_config</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">run_config</span><span class="op">$</span><span class="va">forecast_location</span>,<span class="va">config</span><span class="op">$</span><span class="va">states_config_file</span><span class="op">)</span>, col_types <span class="op">=</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Download and process observations (already done)</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cleaned_observations_file_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">qaqc_data_location</span>,<span class="st">"observations_postQAQC_long.csv"</span><span class="op">)</span>
<span class="va">cleaned_inflow_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">qaqc_data_location</span>, <span class="st">"/inflow_postQAQC.csv"</span><span class="op">)</span>
<span class="va">observed_met_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">qaqc_data_location</span>,<span class="st">"observed-met_fcre.nc"</span><span class="op">)</span></code></pre></div>
<p>Set up weather drivers in GLM format</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">met_out</span> <span class="op">&lt;-</span> <span class="fu">FLAREr</span><span class="fu">::</span><span class="fu"><a href="../reference/generate_glm_met_files.html">generate_glm_met_files</a></span><span class="op">(</span>obs_met_file <span class="op">=</span> <span class="va">observed_met_file</span>,
                                         out_dir <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">run_config</span><span class="op">$</span><span class="va">execute_location</span>,
                                         forecast_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">data_location</span>, <span class="va">config</span><span class="op">$</span><span class="va">forecast_met_model</span><span class="op">)</span>,
                                         <span class="va">config</span><span class="op">)</span></code></pre></div>
<p>Set up inflow and outflow drivers in GLM format</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">inflow_outflow_files</span> <span class="op">&lt;-</span> <span class="fu">FLAREr</span><span class="fu">::</span><span class="fu"><a href="../reference/create_glm_inflow_outflow_files.html">create_glm_inflow_outflow_files</a></span><span class="op">(</span>inflow_file_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">config</span><span class="op">$</span><span class="va">data_location</span>, <span class="va">config</span><span class="op">$</span><span class="va">forecast_inflow_model</span><span class="op">)</span>,
                                                               inflow_obs <span class="op">=</span> <span class="va">cleaned_inflow_file</span>,
                                                               working_directory <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">run_config</span><span class="op">$</span><span class="va">execute_location</span>,
                                                               <span class="va">config</span>,
                                                               state_names <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></code></pre></div>
<p>Create observation matrix. The rows of the matrix are observation type (i.e. temperature) x number of depths model. The columns are the number of days simulated.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu">FLAREr</span><span class="fu">::</span><span class="fu"><a href="../reference/create_obs_matrix.html">create_obs_matrix</a></span><span class="op">(</span><span class="va">cleaned_observations_file_long</span>,
                                <span class="va">obs_config</span>,
                                <span class="va">config</span><span class="op">)</span>
<span class="co">#&gt; Extracting temperature</span></code></pre></div>
<p>Map the states to the observations matrix</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">states_config</span> <span class="op">&lt;-</span> <span class="fu">FLAREr</span><span class="fu">::</span><span class="fu"><a href="../reference/generate_states_to_obs_mapping.html">generate_states_to_obs_mapping</a></span><span class="op">(</span><span class="va">states_config</span>, <span class="va">obs_config</span><span class="op">)</span></code></pre></div>
<p>Initialize the model error vector</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model_sd</span> <span class="op">&lt;-</span> <span class="fu">FLAREr</span><span class="fu">::</span><span class="fu"><a href="../reference/initiate_model_error.html">initiate_model_error</a></span><span class="op">(</span><span class="va">config</span>, <span class="va">states_config</span>, config_file_location <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">run_config</span><span class="op">$</span><span class="va">forecast_location</span><span class="op">)</span></code></pre></div>
<p>Set initial conditions</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">init</span> <span class="op">&lt;-</span> <span class="fu">FLAREr</span><span class="fu">::</span><span class="fu"><a href="../reference/generate_initial_conditions.html">generate_initial_conditions</a></span><span class="op">(</span><span class="va">states_config</span>,
                                             <span class="va">obs_config</span>,
                                             <span class="va">pars_config</span>,
                                             <span class="va">obs</span>,
                                             <span class="va">config</span>,
                                             restart_file <span class="op">=</span> <span class="va">run_config</span><span class="op">$</span><span class="va">restart_file</span>,
                                             historical_met_error <span class="op">=</span> <span class="va">met_out</span><span class="op">$</span><span class="va">historical_met_error</span><span class="op">)</span></code></pre></div>
<p>#Run EnKF</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">enkf_output</span> <span class="op">&lt;-</span> <span class="fu">FLAREr</span><span class="fu">::</span><span class="fu"><a href="../reference/run_da_forecast.html">run_da_forecast</a></span><span class="op">(</span>states_init <span class="op">=</span> <span class="va">init</span><span class="op">$</span><span class="va">states</span>,
                                       pars_init <span class="op">=</span> <span class="va">init</span><span class="op">$</span><span class="va">pars</span>,
                                       aux_states_init <span class="op">=</span> <span class="va">init</span><span class="op">$</span><span class="va">aux_states_init</span>,
                                       obs <span class="op">=</span> <span class="va">obs</span>,
                                       obs_sd <span class="op">=</span> <span class="va">obs_config</span><span class="op">$</span><span class="va">obs_sd</span>,
                                       model_sd <span class="op">=</span> <span class="va">model_sd</span>,
                                       working_directory <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">run_config</span><span class="op">$</span><span class="va">execute_location</span>,
                                       met_file_names <span class="op">=</span> <span class="va">met_out</span><span class="op">$</span><span class="va">filenames</span>,
                                       inflow_file_names <span class="op">=</span> <span class="va">inflow_outflow_files</span><span class="op">$</span><span class="va">inflow_file_name</span>,
                                       outflow_file_names <span class="op">=</span> <span class="va">inflow_outflow_files</span><span class="op">$</span><span class="va">outflow_file_name</span>,
                                       config <span class="op">=</span> <span class="va">config</span>,
                                       pars_config <span class="op">=</span> <span class="va">pars_config</span>,
                                       states_config <span class="op">=</span> <span class="va">states_config</span>,
                                       obs_config <span class="op">=</span> <span class="va">obs_config</span>,
                                       da_method <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">da_method</span>,
                                       par_fit_method <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">par_fit_method</span><span class="op">)</span>
<span class="co">#&gt; Using GLM Version 3.2.0a1</span>
<span class="co">#&gt; Running time step 1 : 2018-10-02 00:00 - 2018-10-03 00:00 [2021-05-21 06:56:28]</span>
<span class="co">#&gt; zone1temp: mean 10.1073 sd 3.0197</span>
<span class="co">#&gt; zone2temp: mean 15.3774 sd 2.8364</span>
<span class="co">#&gt; sw_factor: mean 0.986 sd 0.2961</span>
<span class="co">#&gt; Running time step 2 : 2018-10-03 00:00 - 2018-10-04 00:00 [2021-05-21 06:56:32]</span>
<span class="co">#&gt; zone1temp: mean 10.8451 sd 1.8984</span>
<span class="co">#&gt; zone2temp: mean 14.9783 sd 2.9112</span>
<span class="co">#&gt; sw_factor: mean 0.6882 sd 0.1963</span>
<span class="co">#&gt; Running time step 3 : 2018-10-04 00:00 - 2018-10-05 00:00 [2021-05-21 06:56:35]</span>
<span class="co">#&gt; zone1temp: mean 12.0036 sd 1.3582</span>
<span class="co">#&gt; zone2temp: mean 14.6547 sd 2.726</span>
<span class="co">#&gt; sw_factor: mean 0.6772 sd 0.1153</span>
<span class="co">#&gt; Running time step 4 : 2018-10-05 00:00 - 2018-10-06 00:00 [2021-05-21 06:56:38]</span>
<span class="co">#&gt; zone1temp: mean 12.3964 sd 0.8849</span>
<span class="co">#&gt; zone2temp: mean 14.5902 sd 2.5966</span>
<span class="co">#&gt; sw_factor: mean 0.6829 sd 0.0912</span>
<span class="co">#&gt; Running time step 5 : 2018-10-06 00:00 - 2018-10-07 00:00 [2021-05-21 06:56:41]</span>
<span class="co">#&gt; zone1temp: mean 12.3964 sd 0.8849</span>
<span class="co">#&gt; zone2temp: mean 14.5902 sd 2.5966</span>
<span class="co">#&gt; sw_factor: mean 0.6829 sd 0.0912</span>
<span class="co">#&gt; Running time step 6 : 2018-10-07 00:00 - 2018-10-08 00:00 [2021-05-21 06:56:44]</span>
<span class="co">#&gt; zone1temp: mean 12.3964 sd 0.8849</span>
<span class="co">#&gt; zone2temp: mean 14.5902 sd 2.5966</span>
<span class="co">#&gt; sw_factor: mean 0.6829 sd 0.0912</span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Save forecast</span>
<span class="va">saved_file</span> <span class="op">&lt;-</span> <span class="fu">FLAREr</span><span class="fu">::</span><span class="fu"><a href="../reference/write_forecast_netcdf.html">write_forecast_netcdf</a></span><span class="op">(</span><span class="va">enkf_output</span>,
                                           forecast_location <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">run_config</span><span class="op">$</span><span class="va">forecast_location</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Create EML Metadata</span>
<span class="fu">FLAREr</span><span class="fu">::</span><span class="fu"><a href="../reference/create_flare_metadata.html">create_flare_metadata</a></span><span class="op">(</span>file_name <span class="op">=</span> <span class="va">saved_file</span>,
                        <span class="va">enkf_output</span><span class="op">)</span>
<span class="co">#&gt; • Checking Validity of EML file...</span>
<span class="co">#&gt; ✓ EML is valid</span>
<span class="co">#&gt; ✓ additionalMetadata found</span>
<span class="co">#&gt; ✓ timestep parsable</span>
<span class="co">#&gt; ✓ forecast_horizon parsable</span>
<span class="co">#&gt; ✓ forecast_issue_time found</span>
<span class="co">#&gt; ✓ forecast_iteration_id found</span>
<span class="co">#&gt; ✓ forecast_project_id found</span>
<span class="co">#&gt; ✓ metadata_standard_version found</span>
<span class="co">#&gt; ✓ model_description found</span>
<span class="co">#&gt; ✓ forecast_model_id found</span>
<span class="co">#&gt; ✓ name found</span>
<span class="co">#&gt; ✓ type found</span>
<span class="co">#&gt; ✓ repository found</span>
<span class="co">#&gt; ✓ initial_conditions found</span>
<span class="co">#&gt; ✓ status found</span>
<span class="co">#&gt; ✓ initial_conditions status/uncertainty class valid: assimilates</span>
<span class="co">#&gt; ✓ complexity valid</span>
<span class="co">#&gt; ✓ type found</span>
<span class="co">#&gt; ✓ initial_conditions propagation type valid: ensemble</span>
<span class="co">#&gt; ✓ size valid</span>
<span class="co">#&gt; ✓ type found</span>
<span class="co">#&gt; ✓ reference found</span>
<span class="co">#&gt; ✓ complexity valid</span>
<span class="co">#&gt; ✓ parameters found</span>
<span class="co">#&gt; ✓ status found</span>
<span class="co">#&gt; ✓ parameters status/uncertainty class valid: assimilates</span>
<span class="co">#&gt; ✓ complexity valid</span>
<span class="co">#&gt; ✓ type found</span>
<span class="co">#&gt; ✓ parameters propagation type valid: ensemble</span>
<span class="co">#&gt; ✓ size valid</span>
<span class="co">#&gt; ✓ type found</span>
<span class="co">#&gt; ✓ reference found</span>
<span class="co">#&gt; ✓ complexity valid</span>
<span class="co">#&gt; ✓ drivers found</span>
<span class="co">#&gt; ✓ status found</span>
<span class="co">#&gt; ✓ drivers status/uncertainty class valid: propagates</span>
<span class="co">#&gt; ✓ complexity valid</span>
<span class="co">#&gt; ✓ type found</span>
<span class="co">#&gt; ✓ drivers propagation type valid: ensemble</span>
<span class="co">#&gt; ✓ size valid</span>
<span class="co">#&gt; ✓ random_effects found</span>
<span class="co">#&gt; ✓ status found</span>
<span class="co">#&gt; ✓ random_effects status/uncertainty class valid: absent</span>
<span class="co">#&gt; ✓ process_error found</span>
<span class="co">#&gt; ✓ status found</span>
<span class="co">#&gt; ✓ process_error status/uncertainty class valid: propagates</span>
<span class="co">#&gt; ✓ complexity valid</span>
<span class="co">#&gt; ✓ type found</span>
<span class="co">#&gt; ✓ process_error propagation type valid: ensemble</span>
<span class="co">#&gt; ✓ size valid</span>
<span class="co">#&gt; ✓ obs_error found</span>
<span class="co">#&gt; ✓ status found</span>
<span class="co">#&gt; ✓ obs_error status/uncertainty class valid: data_driven</span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">FLAREr</span><span class="fu">::</span><span class="fu"><a href="../reference/plotting_general.html">plotting_general</a></span><span class="op">(</span>file_name <span class="op">=</span> <span class="va">saved_file</span>,
                        qaqc_location <span class="op">=</span> <span class="va">config</span><span class="op">$</span><span class="va">qaqc_data_location</span><span class="op">)</span>
<span class="co">#&gt; [1] "Extracting temperature"</span>
<span class="co">#&gt; [1] "temp"</span>
<span class="co">#&gt; Warning: Removed 119 rows containing missing values (geom_point).</span>

<span class="co">#&gt; Warning: Removed 119 rows containing missing values (geom_point).</span>
<span class="co">#&gt; [1] "zone1temp"</span>
<span class="co">#&gt; [1] "zone2temp"</span>
<span class="co">#&gt; [1] "sw_factor"</span>
<span class="co">#&gt; [1] "extc_coef"</span>
<span class="co">#&gt; Warning: Removed 1 row(s) containing missing values (geom_path).</span>
<span class="co">#&gt; agg_png </span>
<span class="co">#&gt;       2</span></code></pre></div>
<p>Once the simulation is complete you will find a PDF, a netcdf (.nc) file, and an xml in <code>forecast_location</code> directory. The PDF is the plotted output, the netcdf file is the FLARE output, and the xml is the metadata.</p>
</div>
<div id="modifying-flare" class="section level2">
<h2 class="hasAnchor">
<a href="#modifying-flare" class="anchor"></a>6: Modifying FLARE</h2>
<div id="turning-off-data-assimilation" class="section level3">
<h3 class="hasAnchor">
<a href="#turning-off-data-assimilation" class="anchor"></a>Turning off data assimilation</h3>
<p>In configure_flare.yml you can change <code>da_method</code> to “none”</p>
</div>
<div id="removing-parameter-estimation" class="section level3">
<h3 class="hasAnchor">
<a href="#removing-parameter-estimation" class="anchor"></a>Removing parameter estimation</h3>
<p>Pending</p>
</div>
<div id="increasing-observational-uncertainty" class="section level3">
<h3 class="hasAnchor">
<a href="#increasing-observational-uncertainty" class="anchor"></a>Increasing observational uncertainty</h3>
<p>The second modification you will do is to to increase the observational uncertainty. In <code>observations_config.csv</code> set <code>obs_sd = 1</code>.</p>
</div>
<div id="changing-the-ensemble-size" class="section level3">
<h3 class="hasAnchor">
<a href="#changing-the-ensemble-size" class="anchor"></a>Changing the ensemble size</h3>
<p>The variable <code>ensemble_size</code> allows you to adjust the size of the ensemble.</p>
</div>
<div id="changing-the-number-of-depths-simulated" class="section level3">
<h3 class="hasAnchor">
<a href="#changing-the-number-of-depths-simulated" class="anchor"></a>Changing the number of depths simulated</h3>
<p>The variable <code>modeled_depths</code> allows you to adjust the depths that FLARE simulates</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by R. Quinn Thomas.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
